# FPGA 矩阵计算器功能使用说明文档

## 1. 系统概述

本系统是一个基于 Xilinx Artix-7 FPGA (EGO1 开发板) 的高性能矩阵计算器。系统支持矩阵的串口输入、随机生成、存储管理、全量显示以及多种核心数学运算（加法、乘法、转置、标量乘法）。用户通过 UART 串口终端与系统进行数据交互，并通过板载拨码开关、按钮、LED 和数码管进行实时控制和状态监控。

## 2. 硬件接口与引脚分配

本系统运行于 EGO1 开发板，核心时钟频率为 50MHz (由 100MHz 分频)。

### 2.1 核心控制接口

| 接口名称 | 硬件组件 | EGO1 引脚 | 说明 |
| :--- | :--- | :--- | :--- |
| **系统时钟** | 晶振 | **P17** | 100MHz 输入 |
| **系统复位** | 按键 S6 | **P15** | **rst_n** (低电平有效)。按下复位系统。 |
| **确认/开始** | 按键 S4 | **U4** | **btn**。用于触发操作或确认输入。 |
| **UART TX** | 接口 | **T4** | 串口发送端 (接上位机 RX) |
| **UART RX** | 接口 | **N5** | 串口接收端 (接上位机 TX) |

> **注意**: 请勿使用 S5 按键 (PROG)，否则会擦除 FPGA 配置。

### 2.2 拨码开关 (Switches)

系统使用 8 个拨码开关 (`SW[7:0]`) 进行模式控制。

| 信号 | 引脚 | 功能定义 | 描述 |
| :--- | :--- | :--- | :--- |
| **SW[7]** | **P5** | **矩阵输入 (Input)** | 开启后，允许通过串口输入矩阵数据。 |
| **SW[6]** | **P4** | **矩阵生成 (Gen)** | 开启后，允许通过串口指令生成随机矩阵。 |
| **SW[5]** | **P3** | **矩阵显示 (Show)** | 开启后，系统将所有存储的矩阵数据通过串口打印。 |
| **SW[4]** | **P2** | **计算模式 (Calculate)** | 开启后，进入矩阵运算流程。 |
| **SW[3]** | **R2** | **设置模式 (Settings)** | 开启后，允许修改系统全局参数。 |
| **SW[2]** | **M4** | **运算选择 Bit 2** | 配合 SW[1:0] 选择具体运算类型。 |
| **SW[1]** | **N4** | **运算选择 Bit 1** | - |
| **SW[0]** | **R1** | **运算选择 Bit 0** | - |

> **模式优先级**: Settings (SW3) > Calculate (SW4) > Show (SW5) > Gen (SW6) > Input (SW7)。建议每次仅开启一个模式开关。

### 2.3 LED 状态指示

| 信号 | 引脚 | 名称 | 状态描述 |
| :--- | :--- | :--- | :--- |
| **LED[0]** | **K2** | **Error** | 亮起表示操作出错（如维度不匹配、ID 无效）。在输入/生成模式下，Error 灯会闪烁并自动清除，允许立即重试；在其他模式下可能需要复位。 |
| **LED[1]** | **J2** | **Done** | 亮起表示当前操作成功完成。亮起约 0.5 秒后自动熄灭，表示系统已准备好进行下一次操作。 |
| **LED[2]** | **J3** | **Busy** | 亮起表示系统正在处理数据或计算中，请勿进行其他操作。 |
| **LED[7:3]** | **F6-H4** | **Debug** | 显示当前内部识别的模式代码，用于调试。 |
| **LED[11:8]** | **K3-L1** | **State** | (新增) 显示计算模式下的内部状态机状态。 |
| **LED[15:12]** | **K1-J5** | **Count** | (新增) 显示计算模式下已接收的数字个数。 |

### 2.4 数码管显示

数码管用于显示运算类型或性能计数。

*   **引脚**: 段选 `seg[7:0]` (D5...B4), 位选 `an[3:0]` (H1...G2)。
*   **显示内容**:
    *   **待机/设置/输入**: 熄灭。
    *   **计算模式 (准备)**: 显示运算代码 (`A`:加法, `b`:乘法, `C`:标量乘, `T`:转置)。
    *   **计算模式 (完成)**: 显示运算耗时的时钟周期数 (Cycle Count)。

---

## 3. 详细操作指南

### 3.1 准备工作
1.  连接 USB-TTL 模块：FPGA **T4** 接模块 RX，FPGA **N5** 接模块 TX，共地。
2.  打开串口调试助手：波特率 **115200**，8数据位，1停止位，无校验。
3.  下载比特流文件，按下 **S6 (P15)** 复位系统。

### 3.2 设置模式 (Settings Mode)
配置系统全局参数（如最大行列数、超时时间）。

1.  **进入模式**:
    *   将拨码开关 `SW[3]` 拨至 **ON** (其他保持 OFF)。
    *   此时 LED G3 和 H4 应亮起，表示已进入设置模式。

2.  **发送指令**:
    *   通过串口调试助手发送指令，格式为 `CMD DATA` (空格分隔，**必须以换行符结尾**)。
    *   **指令列表**:
        *   `1 Val\n`: 设置最大行数 (MaxRow, 1-32)。例如: `1 8\n`
        *   `2 Val\n`: 设置最大列数 (MaxCol, 1-32)。例如: `2 8\n`
        *   `3 Val\n`: 设置数据最小值。例如: `3 0\n`
        *   `4 Val\n`: 设置数据最大值。例如: `4 255\n`
        *   `5 Val\n`: 设置倒计时 (秒, 5-15)。例如: `5 10\n`

3.  **执行确认**:
    *   按下开发板上的 **S4 (Confirm)** 按钮。
    *   **成功反馈**: 观察 **LED[1] (Done)** (引脚 J2)。如果设置成功，该 LED 将亮起约 **0.5 秒**。

4.  **连续设置**:
    *   系统支持连续设置。在 Done 灯熄灭后，您可以直接发送下一条指令并再次按下 S4 确认，无需切换开关或复位。
    *   *示例流程*: 发送 `1 8\n` -> 按 S4 (Done亮) -> 发送 `2 8\n` -> 按 S4 (Done亮)。

### 3.3 矩阵输入模式 (Matrix Input Mode)
手动输入矩阵数据。
1.  **设置开关**: `SW[7]` ON。
2.  **发送数据**:
    *   **自动 ID**: `Rows Cols Data...` (如 `2 2 1 2 3 4`)。
    *   **指定 ID**: `-1 ID Name1 Name2 Rows Cols Data...` (如 `-1 1 0 0 2 2 5 6 7 8`)。
3.  **执行**: 按下 **S4 (Confirm)**。等待 LED[1] (Done) 亮起。
4.  **连续输入**: Done 灯熄灭后，您可以直接发送下一个矩阵的数据并再次按下 S4，无需复位或切换模式。
5.  **错误处理**: 如果 LED[0] (Error) 闪烁，说明输入数据有误（如维度超限）。此时输入缓冲区已自动清空，请检查数据后重新发送并按 S4 提交。

### 3.4 矩阵生成模式 (Matrix Gen Mode)
快速生成随机矩阵。
1.  **设置开关**: `SW[6]` ON。
2.  **发送参数**: `Rows Cols Count` (如 `4 4 1` 生成一个 4x4 矩阵)。
3.  **执行**: 按下 **S4 (Confirm)**。系统自动生成并存储，完成后 LED[1] (Done) 亮起。
4.  **连续生成**: Done 灯熄灭后，您可以直接发送新的生成参数并再次按下 S4。
5.  **错误处理**: 如果 LED[0] (Error) 闪烁，说明参数有误（如请求数量过多）。此时缓冲区已清空，请重新发送正确参数并提交。

### 3.5 矩阵显示模式 (Show Mode)
查看所有已存储的矩阵。
1.  **设置开关**: `SW[5]` ON。
2.  **执行**: 按下 **S4 (Confirm)**。
3.  **结果**: 串口终端将依次打印所有有效矩阵的内容。

### 3.6 计算模式 (Calculate Mode)
执行矩阵运算。
1.  **设置开关**: `SW[4]` ON。
2.  **选择运算 (SW[2:0])**:
    *   `000`: **转置 (T)**
    *   `001`: **加法 (A)**
    *   `010`: **乘法 (b)**
    *   `011`: **标量乘 (C)**
3.  **启动**: 按下 **S4 (Confirm)**。此时 LED[2] (Busy) 亮起，表示进入选择流程。
4.  **交互流程** (根据串口提示操作):
    *   **输入维度**:
        *   发送 `Rows Cols` (例如 `3 3`)。
        *   **注意**: 数字之间必须有空格，**必须以换行符结尾** (Hex: `0A` 或 `0D 0A`)。
        *   **调试**: 此时数码管会实时显示已接收到的数字个数（如显示 `0002` 表示已收到 2 个数字）。
        *   按 **S4** 确认。
    *   **选择矩阵 A**: 发送 `ID` (如 `0`) -> 按 **S4**。
    *   **选择矩阵 B** (若需要): 发送 `ID` (如 `1`) -> 按 **S4**。
    *   **输入标量** (若需要): 发送数值 -> 按 **S4**。
5.  **结果**:
    *   LED[1] (Done) 亮起。
    *   数码管显示计算耗时。
    *   结果矩阵自动存储到新的 ID。

## 4. 故障排除
*   **计算模式卡死 (J3 常亮)**:
    *   **观察数码管显示**：
        *   若显示 `0000`：说明未收到数据。请检查串口波特率是否为 **115200**，且发送内容是否包含**换行符**。
        *   若显示 `0002` 但按 S4 无反应：请尝试长按 S4 (>100ms) 再松开，以确保按键被识别。
        *   **若显示 8.8.8.8**：这通常是由于内部时序问题导致的。**请重新综合并烧录最新的比特流**，我们已针对此问题进行了核心逻辑优化（将 BCD 转换改为时序逻辑）。
        *   **若数码管显示正常 (0000) 但系统无响应**：请观察 **LED15-LED8** (K1, H6, H5, J5, K6, L1, M1, K3)：
            *   **LED15-12 (Count)**: 显示已接收并解析成功的数字个数。
                *   若发送数据后此计数不增加，说明 UART 未收到数据或分隔符未被识别。请检查波特率 (115200) 和发送格式（必须有空格或换行）。
                *   **特别注意**：如果在切换模式后遇到此问题，请尝试再次按下 S4 确认键。系统会自动检测并清除之前的残留状态，允许您重新输入。
            *   **LED11-8 (State)**: 显示当前状态。
                *   `0001` (K3亮): 等待输入维度 (GET_DIMS)。需要接收 2 个数字。
                    *   **注意**：如果在此状态下按下 S4 确认键但已接收数字不足 2 个，系统会自动清空缓冲区。请重新发送完整的维度数据（如 `4 4`）。
                *   `0010`: 等待确认行数。
        
        ### 2.5 高级功能与错误处理
        
        #### 2.5.1 随机选择
        在选择矩阵 ID（`SELECT_A` 或 `SELECT_B`）阶段，您可以通过 UART 发送 `-1`（即发送字符串 `-1` 并回车），系统将自动从当前有效的矩阵列表中随机选择一个。
        
        #### 2.5.2 合法性检查与倒计时
        系统会在计算开始前检查操作数的合法性：
        *   **矩阵加法**：要求两个矩阵的维度完全一致。
        *   **矩阵乘法**：要求矩阵 A 的列数等于矩阵 B 的行数。
        
        如果检查失败（例如尝试将 4x4 矩阵与 3x3 矩阵相加）：
        1.  **Error LED** (LED0) 将亮起。
        2.  数码管将显示 **倒计时**（默认 10 秒，从 `10` 倒数至 `0`）。
        3.  您必须在倒计时结束前按下 **S4** 键以重试选择。
        4.  如果倒计时结束仍未操作，系统将自动复位到初始状态。
*   **LED[0] (Error) 闪烁或常亮**: 检查输入维度是否超限，或矩阵 ID 是否存在。在输入/生成模式下，系统会自动复位并清空缓冲区，您可以直接重试。如果 Error 灯常亮且无法恢复，请按 S6 复位。
*   **串口无数据**: 检查波特率 (115200) 及接线 (TX/RX 是否接反)。
*   **数码管不亮**: 确认是否处于计算模式，其他模式默认关闭。
