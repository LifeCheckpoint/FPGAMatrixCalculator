# matrix_storage_manager 使用说明

## 功能

统一管理矩阵数据的 BRAM 存储，支持矩阵写入和读取操作。

## 参数

- `BLOCK_SIZE`: 每个矩阵块大小，默认 1152
- `DATA_WIDTH`: 数据位宽，默认 32
- `ADDR_WIDTH`: 地址位宽，默认 14
- `DEPTH`: BRAM 深度，默认 9216

## 接口

### 写入接口

| 信号 | 方向 | 位宽 | 说明 |
|------|------|------|------|
| `write_request` | 输入 | 1 | 写请求，拉高启动写操作 |
| `write_ready` | 输出 | 1 | 写就绪标志 |
| `matrix_id` | 输入 | 3 | 矩阵 ID (0-7) |
| `actual_rows` | 输入 | 8 | 实际行数 |
| `actual_cols` | 输入 | 8 | 实际列数 |
| `matrix_name` | 输入 | 8[0:7] | 矩阵名称，8 字节 |
| `data_in` | 输入 | 32 | 写入数据 |
| `data_valid` | 输入 | 1 | 数据有效标志 |
| `write_done` | 输出 | 1 | 写完成标志 |
| `writer_ready` | 输出 | 1 | 写模块就绪 |

> **握手约定**：`write_ready` 在状态机处于 `IDLE/DONE` 时为高，表示可以接受新的 `write_request`；`writer_ready` 在 `IDLE` 与尚未写满的 `WRITE_DATA` 阶段为高，用于与 `data_valid` 逐拍握手。

### 读取接口

| 信号 | 方向 | 位宽 | 说明 |
|------|------|------|------|
| `read_addr` | 输入 | 14 | 读地址 |
| `data_out` | 输出 | 32 | 读出数据 |

## 使用流程

### 写入矩阵

1. 等待 `write_ready` 为高，表示状态机空闲或已完成上一笔写入。
2. 设置 `matrix_id`、`actual_rows`、`actual_cols`、`matrix_name` 等元数据信息。
3. 在 `write_ready` 为高时拉高 `write_request` 一周期触发写过程。
4. 元数据写完后 `writer_ready` 会重新拉高，此后在 `writer_ready` 与 `data_valid` 双向握手下持续按行优先送入矩阵数据；当 `writer_ready` 变低或 `write_done` 拉高时停止送数。
5. `write_done` 与 `write_ready` 再次为高时，代表该矩阵写入完成，可开始下一笔写入。

### 读取数据

1. 提供 `read_addr`（绝对地址）
2. 下一周期 `data_out` 输出对应数据

## 地址分配

- 每个矩阵占用 BLOCK_SIZE (1152) 个地址空间
- 矩阵 ID 0-7 分别对应地址段：
  - ID 0: 0x0000 - 0x047F
  - ID 1: 0x0480 - 0x08FF
  - ...
  - ID 7: 0x1C80 - 0x20FF

## 存储格式

每个矩阵块前 3 个地址存储元数据：

- 地址 0: {rows[7:0], cols[7:0], 16'b0}
- 地址 1: matrix_name[0:3]
- 地址 2: matrix_name[4:7]
- 地址 3+: 矩阵数据（行优先）

## 其它事项

1. 写操作期间无法读取，读操作自动在非写状态进行
2. 读延迟 1 周期
3. 矩阵数据必须按行优先顺序连续写入
4. 非写周期 `bram_wr_en` 保持 0，可防止伪写入
